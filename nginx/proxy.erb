server {
  listen <%= port %><%= ' default_server' if default_server.current_value %><%= ' ssl' if ssl.current_value %>;
  server_name <%= url %>;

  access_log /var/log/nginx/server/<%= url %>.access.log combined;
  error_log  /var/log/nginx/server/<%= url %>.error.log;

  <% if ssl.current_value %>
    ssl_certificate     /etc/ssl/private/<%= site %>.crt;
    ssl_certificate_key /etc/ssl/private/<%= site %>.key;

    <% if hsts.current_value %>
      add_header Strict-Transport-Security max-age=31536000;
    <% end %>
  <% end %>

  location / {
    <%= rewrite_config %>
    proxy_pass <%= upstream_url %>;

    <% if sub_filter.set? %>
      sub_filter <%= sub_filter[:from] %> <%= sub_filter[:to] %>;
      sub_filter_once <%= sub_filter[:once] ? 'on' : 'off' %>;
      sub_filter_types <%= sub_filter[:types] %>;
    <% end %>

    <% if upstream_authentication.set? && upstream_authentication == :basic %>
    # Basic authentication header for upstream server
    proxy_set_header Authorization "Basic <%= Base64.strict_encode64 "#{upstream_username}:#{upstream_password}" %>";
    <% end %>

    <% if authentication.set? && authentication == :basic %>
    auth_basic "Restricted";
    auth_basic_user_file <%= htpasswd %>;
    <% end %>
  }
}

<% if hsts.current_value and port != 80 %>
server {
  listen 80;
  server_name <%= url %>;
  rewrite ^ https://<%= url %>;
}
<% end %>
